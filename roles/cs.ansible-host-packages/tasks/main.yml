# This tasks will ensure that whole PIP/Python environment
# and packages needed for running ansible are installed in proper
# versions and conflicting ones are absent.
#
# - PyOpenSSL is deprecated and doesn't work properly with ansible 2.9
#   openssl_* modules, thus uninstall it to force using cryptography module.
#
# - Make sure that all modules are installed from system packages and
#   not via PIP to avoid conflicts.
#
- name: Install dependencies
  yum:
    name:
      - python2-pip
      - yum-plugin-verify
    state: present

- include_tasks: list-packages.yml

- name: Ensure proper PIP package state
  include_tasks: process-package.yml
  loop: "{{ mageops_ansible_pip_packages }}"
  loop_control:
    loop_var: package
    label: "{{ package.pip_name }}"

- include_tasks: list-packages.yml

- name: Print debugging information about installed packages
  debug:
    msg: |
      ==========================================================
      ==          Installed Ansible Module Python Deps        ==
      ==========================================================

      {% for name, version in mageops_ansible_pip_package_versions.items() if name in package_names -%}
      - {{ name }} - version: {{ version }}
      {% endfor %}

      ==========================================================
  vars:
    package_names: "{{ mageops_ansible_pip_packages | map(attribute='pip_name') | list }}"