- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ mageops_cli_lib_path }}"
    - "{{ mageops_cli_lib_path }}/features"
    - "/usr/local/bin"

- name: Configure mageops cli
  template:
    src: "{{ file.src }}"
    dest: "{{ file.dest }}"
    mode: "{{ file.mode }}"
  loop:
    - { src: sysconfig.env,                     dest: "{{ mageops_sysconfig_path }}",                               mode: "0644" }
    - { src: config.bash,                       dest: "{{ mageops_cli_lib_path }}/config.bash",                     mode: "0644" }
  loop_control:
    loop_var: file
    label: "{{ file.src }} -> {{ file.dest }} ({{ file.mode }})"

- name: Install mageops cli
  copy:
    src: "{{ file.src }}"
    dest: "{{ file.dest }}"
    mode: "{{ file.mode }}"
  loop:
    - { src: modout.jq,                         dest: "{{ mageops_cli_lib_path }}/out.jq",                          mode: "0644" }
    - { src: modaws.jq,                         dest: "{{ mageops_cli_lib_path }}/aws.jq",                          mode: "0644" }
    - { src: libaws.bash,                       dest: "{{ mageops_cli_lib_path }}/libaws.bash",                     mode: "0644" }
    - { src: libmageops.bash,                   dest: "{{ mageops_cli_lib_path }}/libmageops.bash",                 mode: "0644" }
    - { src: libnode.bash,                      dest: "{{ mageops_cli_lib_path }}/libnode.bash",                    mode: "0644" }
    - { src: libfeatures.bash,                  dest: "{{ mageops_cli_lib_path }}/libfeatures.bash",                mode: "0644" }
    - { src: features/example_feature.bash,     dest: "{{ mageops_cli_lib_path }}/features/example_feature.bash",   mode: "0644" }
    - { src: mageopscli,                        dest: "/usr/local/bin/mageopscli",                                  mode: "0755" }
    - { src: mageops-update-features.service,   dest: "/etc/systemd/system/mageops-update-features.service",        mode: "0644" }
    - { src: mageops-update-features.timer,     dest: "/etc/systemd/system/mageops-update-features.timer",          mode: "0644" }
    - { src: mageops-update-node-tags.service,  dest: "/etc/systemd/system/mageops-update-node-tags.service",       mode: "0644" }
  loop_control:
    loop_var: file
    label: "{{ file.src }} -> {{ file.dest }} ({{ file.mode }})"
  register: mageops_cli_install

- name: Generate mageops cli shell completions
  when: mageops_cli_install is changed
  shell: /usr/local/bin/mageopscli generate_completions > /etc/profile.d/010-mageops-cli-completions.sh

- name: Enable feature update timer
  service:
    name: mageops-update-features.timer
    enabled: yes
    state: started

- name: Enable node tag updater service
  systemd:
    name: mageops-update-node-tags.service
    enabled: yes
    state: "{{ ( mageops_cli_install is changed ) | ternary('reloaded', 'started') }}"
    daemon_reload: yes
