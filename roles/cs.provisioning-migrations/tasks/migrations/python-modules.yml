# This is to ensure ansible `openssl_*` module work correctly.
# Before we installed `pyOpenSSL` from PIP and it worked fine but now it
# breaks `openssl_privatekey` module because of upgrade to ansible 2.9.
# It seems that ansible loads newer pyOpenSSL, however it also loads
# old `cryptography` module from system instead of the newerr version
# pulled as dependency by PIP.
# The fix is to force ansible to use `cryptography` module and get rid of pyopenssl
# We also need to make sure the paramiko version is compatible.

- name: Uninstall conflicting python modules (PIP packages)
  pip:
    name:
      - pyOpenSSL
      - cryptography
      - paramiko
    state: absent

- name: Uninstall conflicting python modules (RPM packages)
  yum:
    name:
      - pyOpenSSL
    state: absent

- name: Ensure python modules are installed as system packages
  yum:
    name:
      - python2-cryptography
      - python2-paramiko
    state: present