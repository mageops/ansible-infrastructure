# This is not needed for DNF but lets keep it because YUM can still be used.
- name: Set localized yum mirrorlist for core repos
  ini_file:
    path: "/etc/yum.repos.d/{{ item.file }}"
    section: "{{ item.repo }}"
    option: mirrorlist
    value: "{{ item.url }}"
    backup: yes
    no_extra_spaces: yes
  loop: "{{ packages_mirrorlists }}"
  loop_control:
    label: "{{ item.repo }}"
  when: >-
    packages_mirrorlist_countrycode is defined
      and packages_mirrorlist_countrycode

- name: Perform system upgrade
  dnf:
    name: '*'
    state: latest
    update_only: no
    update_cache: no
    # Perform only security upgrades if full udpate is not requested, however,
    # force full upgrade if no maintenance has been evenr performed.
    security: "{{ not packages_full_update and packages_maintenance_performed }}"
    exclude: "{{ packages_full_update_exclude }}"
  register: dnf_upgrade
  retries: 5
  delay: 5
  until: not dnf_upgrade is failed


