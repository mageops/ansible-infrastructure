- import_playbook: site.common.group-current-hosts.yml

- hosts: persistent:&current:!immutable
  roles:
    - role: cs.aws-node-facts
      delegate_to: localhost
      become: no
      when: aws_use
    - role: cs.aws-vpc-facts
      delegate_to: localhost
      delegate_facts: no
      become: no
      when: aws_use
    - role: cs.aws-security-group-facts
      delegate_to: localhost
      delegate_facts: no
      become: no
      when: aws_use
    - role: cs.switch-to-dnf
    - role: pinkeen.selinux-disable
      when: mageops_virtualization_full | default(true)
    - role: cs.swap
    - role: cs.earlyoom
      when: mageops_earlyoom_enable
    - role: cs.provisioning-migrations
    - role: cs.packages
    - role: cs.mageops-cli-profile
    - role: cs.mageops-cli-user
      mageops_cli_user: root
      mageops_cli_user_bashrc_fragments:
        - elasticsearch
        - redis
    - role: cs.mageops-authorize-keys
    - role: cs.aws-cli
      when: aws_use
    - role: cs.cron
    - role: geerlingguy.ntp
    - role: cs.elasticsearch
      tags: elasticsearch
      when: mageops_elasticsearch_create
    - role: cs.redis
      when: mageops_redis_create and not redis_aws_elasticache_use
    - role: cs.redis
      redis_instance_name: sessions
      redis_databases: 1
      redis_port: "{{ mageops_redis_sessions_port }}"
      redis_maxmemory_policy: "{{ redis_sessions_maxmemory_policy }}"
      redis_maxmemory: "{{ redis_sessions_maxmemory }}"
      redis_persistence_enable: "{{ redis_sessions_persistence_enable }}"
      when: mageops_redis_sessions_create
    - role: cs.varnish-purge-proxy
      when: varnish_is_in_autoscaling_group
    - role: cs.aws-logs
      when: aws_use
    - role: cs.sftp-access
      when: sftp_access_enabled
    - role: cs.aws-efs
      when: aws_use and sftp_access_enabled
    - role: cs.rabbitmq
      when: mageops_rabbitmq_create
    - role: cs.magento-cron-http-trigger
      when: mageops_app_is_magesuite

  tasks:
    - include_tasks: "{{ mageops_extra_tasks_persistent_node }}"
      when: mageops_extra_tasks_persistent_node is defined

  vars:
    mageops_node_role: persistent
