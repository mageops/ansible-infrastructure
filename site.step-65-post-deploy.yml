- import_playbook: site.common.group-current-hosts.yml

- hosts: app:&current
  gather_facts: no
  tasks:
    - name: Wait app nodes to be reachble
      wait_for_connection:
        delay: 10
        timeout: 300

# Non-zero status means setup:upgrade is required
# bin/magento setup:db:status 
# systemctl stop supervisord 

# su - {{ magento_user }} -c 'php {{ magento_live_release_dir }}/bin/magento maintenance:enable'
# su - {{ magento_user }} -c 'php {{ magento_live_release_dir }}/bin/magento setup:upgrade --keep-generated'
# su - {{ magento_user }} -c 'php {{ magento_live_release_dir }}/bin/magento maintenance:disable'

# systemctl start supervisord
- hosts: app:&current
  gather_facts: no
  tasks:
    - name: Run Magento setup upgrade
      command: "{{ item.cmd | default(item) }}"
      args:
        chdir: "{{ item.dir | default(magento_live_release_dir) }}"
      run_once: true
      become: yes
      become_user: "{{ magento_user }}"
      loop: 
        - "bin/magento app:config:import --no-interaction"
        - "bin/magento setup:upgrade --keep-generated"
        - "bin/magento maintenance:disable"
        # - "bin/magento cache:flush full_page"
        - "{{ magento_live_release_dir }}{{ magento_node_warmup_script_path }}"
      loop_control:
        label: "{{ item.cmd | default(item) }}"
      register: out

    - name: Show Magento post-deploy command output
      debug:
        msg: "{{ result.stdout | default('--- N/A ---') }}"
      loop: "{{ out.results }}"
      loop_control:
        loop_var: result
        label: "{{ result.cmd | default([]) | join(' ') }}"

- hosts: app:&current
  gather_facts: no
  tasks:
    - name: Run Magento post-deploy commands
      command: "{{ item.cmd | default(item) }}"
      args:
        chdir: "{{ item.dir | default(magento_live_release_dir) }}"
      run_once: true
      become: yes
      become_user: "{{ magento_user }}"
      loop: "{{ magento_post_deploy_commands | default([]) }}"
      loop_control:
        label: "{{ item.cmd | default(item) }}"
      register: out

    - name: Show Magento post-deploy command output
      debug:
        msg: "{{ result.stdout | default('--- N/A ---') }}"
      loop: "{{ out.results }}"
      loop_control:
        loop_var: result
        label: "{{ result.cmd | default([]) | join(' ') }}"


- hosts: app:&current
  gather_facts: no
  tasks:
    - name: Start supervisord Magento workers
      command: /usr/bin/systemctl start supervisord