- name: Setup basic services
  import_playbook: site.step-11-infrastructure.yml

- name: Setup persistence services
  import_playbook: site.step-20-persistent.yml

- name: Setup app services
  import_playbook: site.step-40-app-node.yml

- hosts: raccoon
  roles:
    - role: geerlingguy.composer
    - role: cs.packages
    - role: cs.sshd
    - role: cs.nodejs
    - role: cs.unison-server
    - role: cs.raccoon-sudo
    - role: cs.mageops-cli-user
      mageops_cli_user_name: "{{ magento_user }}"
      mageops_cli_user_crypted_password: "{{ raccoon_app_user_crypted_password }}"
      mageops_cli_user_group: "{{ magento_group }}"
      mageops_cli_user_uid: "{{ magento_uid }}"
      mageops_cli_user_gid: "{{ magento_gid }}"
      mageops_cli_user_umask: "{{ magento_umask }}"
      mageops_cli_user_bashrc_fragments:
        - magento
    - role: cs.mageops-cli-user
      mageops_cli_user_name: root
      mageops_cli_user_crypted_password: "{{ raccoon_root_user_crypted_password }}"
      mageops_cli_user_bashrc_fragments:
        - magento-root
        - elasticsearch
        - nginx
        - redis
        - varnish
    - role: cs.authorize-local-keys
      authorize_local_keys_for_users:
        - root
        - "{{ magento_user }}"
      when: mageops_authorize_local_keys | default(false) and ansible_connection != 'local'

    - role: cs.raccoon-docker
      when: raccoon_virt == 'docker'

  tasks:
    - name: Install composer parallel download plugin
      composer:
        command: require
        global_command: yes
        arguments: hirak/prestissimo
      become_user: "{{ magento_user }}"
      become: yes

    - include_tasks: "{{ mageops_project_vars_dir }}/{{ item }}"
      when: raccoon_tasks_project is defined
      loop: "{{ raccoon_tasks_project }}"

  vars:
    packages_install: "{{ mageops_packages_common + mageops_packages_raccoon_node }}"
    mageops_node_role: raccoon