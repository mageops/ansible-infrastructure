- import_playbook: site.common.group-current-hosts.yml

- hosts: varnish:&current:!immutable
  roles:
    - role: cs.aws-node-facts
      delegate_to: localhost
      become: no
      when: aws_use
    - role: cs.switch-to-dnf
    - role: pinkeen.selinux-disable
      when: mageops_virtualization_full | default(true)
    - role: cs.swap
    - role: cs.earlyoom
      when: mageops_earlyoom_enable
    - role: cs.provisioning-migrations
    - role: cs.packages
    - role: cs.mageops-cli-profile
    - role: cs.mageops-cli-user
      mageops_cli_user_name: root
      mageops_cli_user_bashrc_fragments:
        - varnish
        - nginx
    - role: cs.mageops-cli-user
      mageops_cli_user_name: "{{ magento_user }}"
      mageops_cli_user_group: "{{ magento_group }}"
      mageops_cli_user_uid: "{{ magento_uid }}"
      mageops_cli_user_gid: "{{ magento_gid }}"
      mageops_cli_user_bashrc_fragments:
        - debug-tunnel
      when: mageops_xdebug_proxy_remote_connection_to_loadbalancer
    - role: cs.mageops-authorize-keys
    - role: cs.aws-cli
      when: aws_use
    - role: cs.cron
    - role: geerlingguy.ntp
    - role: cs.nginx
    - role: cs.nginx-url-blacklist
    - role: cs.nginx-https-termination
      when: mageops_https_termination_enable
    - role: cs.nginx-language-redirect
      when: mageops_language_redirect_enable
    - role: cs.varnish
    - role: cs.varnish-manager
      when: varnish_standalone and aws_use
    - role: cs.mageops-cli-profile
    - role: cs.goaccess
      when: goaccess_enable
    - role: cs.aws-logs
      when: aws_use

  vars:
    mageops_node_role: varnish

